<!DOCTYPE html>
<html lang="en">

<head>
  <title>Display XML</title>
  <meta charset="utf-8">
  <style>
    table,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 5px;
    }
  </style>
  <script>
    /**
     * Load a specific XML File
     */
    function loadXML() {
      console.log("<XMLHttpRequest>");
      var request = new XMLHttpRequest();
      console.log("</XMLHttpRequest>");
      request.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
          parse(this);
        }
      };
      request.open("GET", "../../examples/AcetylO2/Acetyl_O2_associationEx.xml", true);
      request.send();
    }

    /**
     * Count the number of elements with a specific attribute.
     * @param Element[] elements
     * @param String attribute_name
     * @return int
     */
    function count(elements, attribute_name) {
      var r = 0;
      for (var i = 0; i < elements.length; i++) {
        if (elements[i].getAttribute(attribute_name) != null) {
          r++;
        }
      }
      return r;
    }

    /**
    * Parse the xml.
    * @param XMLHttpRequest xml
    */
    function parse(xml) {
      console.log("Parsing xml...");

      var xmlDoc = xml.responseXML;

      /**
       * Log to console and display me.title.
       */
      console.log("typeof xmlDoc = " + typeof xmlDoc);
      console.log("xmlDoc.toString() = " + xmlDoc.toString());
      let elements = xmlDoc.getElementsByTagName('*');
      console.log("Number of elements=" + elements.length);
      for (let i = 0; i < elements.length; i++) {
        let nn = elements[i].nodeName;
        //let tn = elements[i].tagName;
        //let nn = elements[i].getNodeName();
        if (nn != null) {
          //console.log("elements[" + i + "].nodeName = " + nn);
          //console.log("elements[" + i + "].tagName = " + nn);
          let cn = elements[i].childNodes[0];
          if (cn != null) {
            let nv = cn.nodeValue;
            if (nv != null) {
              nv = nv.trim();
              if (nv.length > 0) {
                if (nn === "me:title") {
                  document.getElementById("metitle").innerHTML = nv;
                }
                //console.log("elements[" + i + "].childNodes[0].nodeValue = " + nv);
              }
            }
          }
        }
      }
      // The following does not work because of the ":" in the tag.
      //var title = xmlDoc.getElementsByTagName('me:title').nodeValue;
      //console.log("Title=" + title);
      //document.getElementById("metitle").innerHTML = title;

      /**
       * Generate molecules table.
       */
      document.getElementById("molecules").innerHTML = getTable(generateMoleculesTable(xmlDoc));

      /**
       * Generate reactions table.
       */
      document.getElementById("reactions").innerHTML = getTable(generateReactionsTable(xmlDoc));

    }

    /**
     * Generate reactions table.
     * @param XMLDocument xmlDoc
     * @return String
     */
    function generateReactionsTable(xmlDoc) {
      var reactions = xmlDoc.getElementsByTagName('reaction');
      console.log("" + reactions.length + " = Number of reactions");
      // Report number of reactions with id attributes.
      console.log(count(reactions, "id") + " = Number of reactions with ids");
      // Prepare table headings.
      names = ["ID", "Reactants", "Products"];
      //names = ["ID", "Reactants", "Products", "Transition State", "PreExponential", "Activation Energy", "TInfinity", "NInfinity"];
      var table = getTH(names);
      // Process each reaction.
      for (let i = 0; i < reactions.length; i++) {
        let id = reactions[i].getAttribute("id");
        var treactants = "";
        var tproducts = "";
        var ttransitionState = "";
        var tpreExponential = "";
        var tactivationEnergy = "";
        var ttInfinity = "";
        var tnInfinity = "";
        if (id != null) {
          console.log("id = " + id);
          let elements = reactions[i].getElementsByTagName("*");
          console.log("elements.length = " + elements.length);
          for (let j = 0; j < elements.length; j++) {
            //console.log("elements[" + j + "] = " + elements[j]);
            //console.log("elements[" + j + "].length = " + elements[j].length);
            console.log("elements[" + j + "].nodeName = " + elements[j].nodeName);
            //console.log("elements[" + j + "].nodeValue = " + elements[j].nodeValue);
            if (elements[j].nodeName === "reactant") {
              let molecules = elements[j].getElementsByTagName("molecule");
              //console.log("molecules =" + molecules);
              console.log("molecules.length =" + molecules.length);
              if (molecules.length > 0) {
                var moleculeRef = molecules[0].getAttribute("ref");
                console.log("moleculeRef =" + moleculeRef);
                var moleculeRole = molecules[0].getAttribute("role");
                console.log("moleculeRole =" + moleculeRole);
                treactants += molecules[0].getAttribute("ref");
                for (let k = 1; k < molecules.length; k++) {
                  //console.log("molecules[" + k + "] = " + molecules[k]);
                  //console.log("molecules[" + k + "].length = " + molecules[k].length);
                  console.log("molecules[" + k + "].nodeName = " + molecules[k].nodeName);
                  //console.log("molecules[" + k + "].nodeValue = " + molecules[k].nodeValue);
                  //let cn = molecules[k].childNodes;
                  //console.log("cn.length =" + cn.length);
                  moleculeRef = molecules[k].getAttribute("ref");
                  console.log("moleculeRef =" + moleculeRef);
                  moleculeRole = molecules[k].getAttribute("role");
                  console.log("moleculeRole =" + moleculeRole);
                  //&#43; is the HTML entity for the plus sign.
                  //treactants += " &#43; ";
                  //treactants += moleculeRef;
                  treactants += " " + moleculeRef;
                }
              }
            } else if (elements[j].nodeName === "product") {
              let molecules = elements[j].getElementsByTagName("molecule");
              //console.log("molecules =" + molecules);
              console.log("molecules.length =" + molecules.length);
              if (molecules.length > 0) {
                var moleculeRef = molecules[0].getAttribute("ref");
                console.log("moleculeRef =" + moleculeRef);
                var moleculeRole = molecules[0].getAttribute("role");
                console.log("moleculeRole =" + moleculeRole);
                tproducts += molecules[0].getAttribute("ref");
                for (let k = 1; k < molecules.length; k++) {
                  //console.log("molecules[" + k + "] = " + molecules[k]);
                  //console.log("molecules[" + k + "].length = " + molecules[k].length);
                  console.log("molecules[" + k + "].nodeName = " + molecules[k].nodeName);
                  //console.log("molecules[" + k + "].nodeValue = " + molecules[k].nodeValue);
                  //let cn = molecules[k].childNodes;
                  //console.log("cn.length =" + cn.length);
                  moleculeRef = molecules[k].getAttribute("ref");
                  console.log("moleculeRef =" + moleculeRef);
                  moleculeRole = molecules[k].getAttribute("role");
                  console.log("moleculeRole =" + moleculeRole);
                  //&#43; is the HTML entity for the plus sign.
                  //tproducts += " &#43; ";
                  //tproducts += moleculeRef;
                  tproducts += " " + moleculeRef;
                }
              }
            } else {
              console.log("elements[" + j + "].nodeName = " + elements[j].nodeName);
            }
            //let molecule = reactants[j].getElementsByTagName("molecule");
            //let moleculeRef = molecule.getAttribute("ref");
            //treactants += " + " + moleculeRef;
          }
          console.log("tproducts =" + tproducts);
          table += getTR(getTD(id) + getTD(treactants) + getTD(tproducts));
          console.log("table =" + table);
          //table += getTR(getTD(id) + getTD(reactants) + getTD(products) + getTD(transitionState) + getTD(preExponential) + getTD(activationEnergy) + getTD(tInfinity) + getTD(nInfinity));
        }
      }
      return table;
    }

    /**
     * Generate molecules table.
     * @param XMLDocument xmlDoc
     * @return String
     */
    function generateMoleculesTable(xmlDoc) {
      var molecules = xmlDoc.getElementsByTagName('molecule');
      console.log("" + molecules.length + " = Number of molecules");
      // Report number of molecules with id and description attributes.
      console.log(count(molecules, "id") + " = Number of molecules with ids");
      console.log(count(molecules, "description") + " = Number of molecules with descriptions");
      // Prepare table headings.
      const names = ["Name", "Energy<br>kJ/mol", "Rotational constants<br>cm<sup>-1</sup>", "Vibrational frequencies<br>cm<sup>-1</sup>"];
      var table = getTH(names);
      // Process each molecule.
      for (let i = 0; i < molecules.length; i++) {
        var energy = "";
        var rotationalConstants = "";
        var vibrationalFrequencies = "";
        let id = molecules[i].getAttribute("id");
        if (id != null) {
          console.log("id =" + id);
          let propertyList = molecules[i].getElementsByTagName("propertyList");
          for (let j = 0; j < propertyList.length; j++) {
            let property = propertyList[j].getElementsByTagName("property");
            console.log("property.length =" + property.length);
            for (let k = 0; k < property.length; k++) {
              let dictRef = property[k].getAttribute("dictRef");
              if (dictRef != null) {
                if (dictRef === "me:ZPE") {
                  console.log("dictRef =" + dictRef);
                  let scalar = property[k].getElementsByTagName("scalar");
                  console.log("scalar =" + scalar);
                  console.log("scalar.length =" + scalar.length);
                  let cn = scalar[0].childNodes;
                  console.log("cn.length =" + cn.length);
                  for (let l = 0; l < cn.length; l++) {
                    console.log("cn[" + l + "]");
                    if (cn[l] != null) {
                      console.log("cn[" + l + "] =" + cn[l]);
                      console.log("cn[" + l + "].length =" + cn[l].length);
                      console.log("cn[" + l + "].nodeName =" + cn[l].nodeName);
                      console.log("cn[" + l + "].nodeValue =" + cn[l].nodeValue);
                      energy = cn[l].nodeValue;
                      console.log("energy =" + energy);
                    }
                  }
                } else if (dictRef === "me:rotConsts") {
                  console.log("dictRef =" + dictRef);
                  let array = property[k].getElementsByTagName("array");
                  console.log("array =" + array);
                  console.log("array.length =" + array.length);
                  let cn = array[0].childNodes;
                  console.log("cn.length =" + cn.length);
                  for (let l = 0; l < cn.length; l++) {
                    console.log("cn[" + l + "]");
                    if (cn[l] != null) {
                      console.log("cn[" + l + "] =" + cn[l]);
                      console.log("cn[" + l + "].length =" + cn[l].length);
                      console.log("cn[" + l + "].nodeName =" + cn[l].nodeName);
                      console.log("cn[" + l + "].nodeValue =" + cn[l].nodeValue);
                      rotationalConstants = cn[l].nodeValue;
                      console.log("rotationalConstants =" + rotationalConstants);
                    }
                  }
                } else if (dictRef === "me:vibFreqs") {
                  console.log("dictRef =" + dictRef);
                  let array = property[k].getElementsByTagName("array");
                  console.log("array =" + array);
                  console.log("array.length =" + array.length);
                  let cn = array[0].childNodes;
                  console.log("cn.length =" + cn.length);
                  for (let l = 0; l < cn.length; l++) {
                    console.log("cn[" + l + "]");
                    if (cn[l] != null) {
                      console.log("cn[" + l + "] =" + cn[l]);
                      console.log("cn[" + l + "].length =" + cn[l].length);
                      console.log("cn[" + l + "].nodeName =" + cn[l].nodeName);
                      console.log("cn[" + l + "].nodeValue =" + cn[l].nodeValue);
                      vibrationalFrequencies = cn[l].nodeValue;
                      console.log("vibrationalFrequencies =" + vibrationalFrequencies);
                    }
                  }
                } else {
                  console.log("dictRef =" + dictRef);
                }
              }
            }
          }
          table += getTR(getTD(id) + getTD(energy) + getTD(rotationalConstants) + getTD(vibrationalFrequencies));
        }
      }
      return table;
    }

    /*
    * @param headings An array of strings.
    * @return String
    */
    function getTH(headings) {
      var th = "";
      for (let i = 0; i < headings.length; i++) {
        th += "<th>" + headings[i] + "</th>"
      }
      return getTR(th);
    }

    /*
    * @param String x A cell for a table row.
    * @return x wrapped in td tags.
    */
    function getTD(x) {
      console.log("getTD(" + x + ")");
      return "<td>" + x + "</td>";
    }

    /*
    * @param String x A row for a table.
    * @return x wrapped in tr tags.
    */
    function getTR(x) {
      return "<tr>" + x + "</tr>\n";
    }

    /*
    * @param String x Table rows for a table.
    * @return x wrapped in table tags.
    */
    function getTable(x) {
      return "<table>" + x + "</table>";
    }
  </script>

</head>

<body>

  <button type="button" onclick="loadXML()">Load XML</button>

  <!-- Main heading -->
  <h1 id="metitle"></h1>

  <!-- Display table for molecules -->
  <div id="molecules_div">
    <h2>Molecules</h2>
    <table id="molecules"></table>
  </div>

  <!-- Display table for reactions -->
  <div id="reactions_div">
    <h2>Reactions</h2>
    <table id="reactions"></table>
  </div>

</body>

</html>